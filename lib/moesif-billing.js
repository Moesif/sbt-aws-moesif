"use strict";
// Copyright Moesif, Inc. All Rights Reserved.
// SPDX-License-Identifier: Apache-2.0
Object.defineProperty(exports, "__esModule", { value: true });
exports.MoesifBilling = void 0;
const constructs_1 = require("constructs");
const lambda = require("aws-cdk-lib/aws-lambda");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const path = require("path");
class MoesifBilling extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.managementAPIBaseUrl = props.managementAPIBaseUrl || 'https://api.moesif.com';
        this.logGroupName = 'MoesifBilling';
        /**
         * The function to trigger when creating a new billing user.
         */
        const billingUserService = new lambda.Function(this, 'MoesifManagement', {
            runtime: lambda.Runtime.PYTHON_3_12,
            handler: 'billing_management.handler',
            tracing: lambda.Tracing.ACTIVE,
            timeout: aws_cdk_lib_1.Duration.seconds(60),
            logGroup: new aws_cdk_lib_1.aws_logs.LogGroup(this, this.logGroupName, {
                retention: aws_cdk_lib_1.aws_logs.RetentionDays.FIVE_DAYS,
            }),
            code: lambda.Code.fromAsset(path.resolve(__dirname, '../resources/functions/billing_management')), // Path to the directory containing your Lambda function code
            environment: {
                MOESIF_MANAGEMENT_API_KEY: props.managementAPIKey,
                MOESIF_MANAGEMENT_BASE_URL: this.managementAPIBaseUrl,
                BILLING_PROVIDER_SLUG: props.billingProviderSlug,
                BILLING_PROVIDER_SECRET_KEY: props.billingProviderSecretKey,
                DEFAULT_PRICE_ID: props.defaultPriceId
            },
        });
        this.createUserFunction = billingUserService;
        this.deleteUserFunction = billingUserService;
        this.ingestor = null; // TODO. We don't need an ingestor/aggregator
        this.putUsageFunction = billingUserService; // TODO. Prefer handling via firehose
        this.webhookFunction = null; // TODO What is this for?
        this.webhookPath = null; // TODO What is this for?
    }
}
exports.MoesifBilling = MoesifBilling;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9lc2lmLWJpbGxpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJtb2VzaWYtYmlsbGluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsOENBQThDO0FBQzlDLHNDQUFzQzs7O0FBRXRDLDJDQUF1QztBQUN2QyxpREFBaUQ7QUFDakQsNkNBQWlEO0FBR2pELDZCQUE2QjtBQXdCN0IsTUFBYSxhQUFjLFNBQVEsc0JBQVM7SUFVeEMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUF5QjtRQUMvRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxLQUFLLENBQUMsb0JBQW9CLElBQUksd0JBQXdCLENBQUE7UUFDbEYsSUFBSSxDQUFDLFlBQVksR0FBRyxlQUFlLENBQUE7UUFFbkM7O1dBRUc7UUFDSCxNQUFNLGtCQUFrQixHQUFxQixJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLGtCQUFrQixFQUFFO1lBQ3ZGLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7WUFDbkMsT0FBTyxFQUFFLDRCQUE0QjtZQUNyQyxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNO1lBQzlCLE9BQU8sRUFBRSxzQkFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7WUFDN0IsUUFBUSxFQUFFLElBQUksc0JBQVEsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUU7Z0JBQ3JELFNBQVMsRUFBRSxzQkFBUSxDQUFDLGFBQWEsQ0FBQyxTQUFTO2FBQzlDLENBQUM7WUFDRixJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsMkNBQTJDLENBQUMsQ0FBQyxFQUFFLDZEQUE2RDtZQUNoSyxXQUFXLEVBQUU7Z0JBQ1QseUJBQXlCLEVBQUUsS0FBSyxDQUFDLGdCQUFnQjtnQkFDakQsMEJBQTBCLEVBQUUsSUFBSSxDQUFDLG9CQUFvQjtnQkFDckQscUJBQXFCLEVBQUUsS0FBSyxDQUFDLG1CQUFtQjtnQkFDaEQsMkJBQTJCLEVBQUUsS0FBSyxDQUFDLHdCQUF3QjtnQkFDM0QsZ0JBQWdCLEVBQUUsS0FBSyxDQUFDLGNBQWM7YUFDekM7U0FDSixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsa0JBQWtCLENBQUM7UUFDN0MsSUFBSSxDQUFDLGtCQUFrQixHQUFHLGtCQUFrQixDQUFDO1FBQzdDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBVyxDQUFDLENBQUMsNkNBQTZDO1FBQzFFLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxrQkFBa0IsQ0FBQyxDQUFFLHFDQUFxQztRQUNsRixJQUFJLENBQUMsZUFBZSxHQUFHLElBQVcsQ0FBQyxDQUFDLHlCQUF5QjtRQUM3RCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQVcsQ0FBQyxDQUFDLHlCQUF5QjtJQUM3RCxDQUFDO0NBQ0o7QUE1Q0Qsc0NBNENDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IE1vZXNpZiwgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuLy8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjBcblxuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBhd3NfbG9ncywgRHVyYXRpb24gfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBJRGF0YUluZ2VzdG9yQWdncmVnYXRvciB9IGZyb20gJ0BjZGtsYWJzL3NidC1hd3MvbGliL2NvbnRyb2wtcGxhbmUvaW5nZXN0b3ItYWdncmVnYXRvci9pbmdlc3Rvci1hZ2dyZWdhdG9yLWludGVyZmFjZSc7XG5pbXBvcnQgeyBJQmlsbGluZyB9IGZyb20gJ0BjZGtsYWJzL3NidC1hd3MvbGliL2NvbnRyb2wtcGxhbmUvYmlsbGluZy9iaWxsaW5nLWludGVyZmFjZSc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuXG5leHBvcnQgaW50ZXJmYWNlIE1vZXNpZkJpbGxpbmdQcm9wcyB7XG5cbiAgICAvLyBDb2xsZWN0b3IgQXBwbGljYXRpb24gSWQgZnJvbSB5b3VyIE1vZXNpZiBhY2NvdW50IGZvciBldmVudCBpbmdlc3Rpb25cbiAgICByZWFkb25seSBhcHBsaWNhdGlvbklkOiBzdHJpbmcgXG5cbiAgICAvLyBNYW5hZ2VtZW50IEFQSSBLZXkgZnJvbSB5b3VyIE1vZXNpZiBhY2NvdW50LiBUaGUga2V5IG11c3QgaGF2ZSB0aGUgZm9sbG93aW5nIHNjb3BlczpcbiAgICAvLyBjcmVhdGU6dXNlcnMgY3JlYXRlOmNvbXBhbmllcyBkZWxldGU6dXNlcnMgZGVsZXRlOmNvbXBhbmllcyAgIFxuICAgIHJlYWRvbmx5IG1hbmFnZW1lbnRBUElLZXk6IHN0cmluZyAgIFxuXG4gICAgLy8gVVJMIGZvciB0aGUgTW9lc2lmIE1hbmdhZW1lbnQgQVBJXG4gICAgcmVhZG9ubHkgbWFuYWdlbWVudEFQSUJhc2VVcmw/OiBzdHJpbmdcblxuICAgIC8vIENyZWRlbnRpYWxzIGZvciB0aGUgQmlsbGluZyBQcm92aWRlciAvIFBheW1lbnQgR2F0ZXdheVxuICAgIHJlYWRvbmx5IGJpbGxpbmdQcm92aWRlclNsdWc6IHN0cmluZ1xuXG4gICAgcmVhZG9ubHkgYmlsbGluZ1Byb3ZpZGVyU2VjcmV0S2V5OiBzdHJpbmdcblxuICAgIC8vIERlZmF1bHQgcHJpY2UgdG8gYmUgdXNlZCB3aGVuIGNyZWF0aW5nIG5ldyBzdWJzY3JpcHRpb25zXG4gICAgLy8gVE9ETyB0aGlzIHNob3VsZCBiZSBkZXRlcm1pbmVkIGJ5IHBsYW4vcHJpY2Ugc2VsZWN0ZWQgYnkgY3VzdG9tZXJcbiAgICByZWFkb25seSBkZWZhdWx0UHJpY2VJZDogc3RyaW5nXG4gIH1cblxuZXhwb3J0IGNsYXNzIE1vZXNpZkJpbGxpbmcgZXh0ZW5kcyBDb25zdHJ1Y3QgaW1wbGVtZW50cyBJQmlsbGluZyB7XG4gICAgcmVhZG9ubHkgY3JlYXRlVXNlckZ1bmN0aW9uOiBsYW1iZGEuSUZ1bmN0aW9uO1xuICAgIHJlYWRvbmx5IGRlbGV0ZVVzZXJGdW5jdGlvbjogbGFtYmRhLklGdW5jdGlvbjtcbiAgICByZWFkb25seSBpbmdlc3RvcjogSURhdGFJbmdlc3RvckFnZ3JlZ2F0b3I7XG4gICAgcmVhZG9ubHkgcHV0VXNhZ2VGdW5jdGlvbjogbGFtYmRhLklGdW5jdGlvbjtcbiAgICByZWFkb25seSB3ZWJob29rRnVuY3Rpb24/OiBsYW1iZGEuSUZ1bmN0aW9uO1xuICAgIHJlYWRvbmx5IHdlYmhvb2tQYXRoPzogc3RyaW5nO1xuICAgIHJlYWRvbmx5IG1hbmFnZW1lbnRBUElCYXNlVXJsOiBzdHJpbmc7XG4gICAgcmVhZG9ubHkgbG9nR3JvdXBOYW1lOiBzdHJpbmdcblxuICAgIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBNb2VzaWZCaWxsaW5nUHJvcHMpIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgICAgICB0aGlzLm1hbmFnZW1lbnRBUElCYXNlVXJsID0gcHJvcHMubWFuYWdlbWVudEFQSUJhc2VVcmwgfHwgJ2h0dHBzOi8vYXBpLm1vZXNpZi5jb20nXG4gICAgICAgIHRoaXMubG9nR3JvdXBOYW1lID0gJ01vZXNpZkJpbGxpbmcnXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFRoZSBmdW5jdGlvbiB0byB0cmlnZ2VyIHdoZW4gY3JlYXRpbmcgYSBuZXcgYmlsbGluZyB1c2VyLlxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3QgYmlsbGluZ1VzZXJTZXJ2aWNlOiBsYW1iZGEuSUZ1bmN0aW9uID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCAnTW9lc2lmTWFuYWdlbWVudCcsIHtcbiAgICAgICAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLlBZVEhPTl8zXzEyLFxuICAgICAgICAgICAgaGFuZGxlcjogJ2JpbGxpbmdfbWFuYWdlbWVudC5oYW5kbGVyJyxcbiAgICAgICAgICAgIHRyYWNpbmc6IGxhbWJkYS5UcmFjaW5nLkFDVElWRSxcbiAgICAgICAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLnNlY29uZHMoNjApLFxuICAgICAgICAgICAgbG9nR3JvdXA6IG5ldyBhd3NfbG9ncy5Mb2dHcm91cCh0aGlzLCB0aGlzLmxvZ0dyb3VwTmFtZSwge1xuICAgICAgICAgICAgICAgIHJldGVudGlvbjogYXdzX2xvZ3MuUmV0ZW50aW9uRGF5cy5GSVZFX0RBWVMsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vcmVzb3VyY2VzL2Z1bmN0aW9ucy9iaWxsaW5nX21hbmFnZW1lbnQnKSksIC8vIFBhdGggdG8gdGhlIGRpcmVjdG9yeSBjb250YWluaW5nIHlvdXIgTGFtYmRhIGZ1bmN0aW9uIGNvZGVcbiAgICAgICAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgICAgICAgICAgTU9FU0lGX01BTkFHRU1FTlRfQVBJX0tFWTogcHJvcHMubWFuYWdlbWVudEFQSUtleSxcbiAgICAgICAgICAgICAgICBNT0VTSUZfTUFOQUdFTUVOVF9CQVNFX1VSTDogdGhpcy5tYW5hZ2VtZW50QVBJQmFzZVVybCxcbiAgICAgICAgICAgICAgICBCSUxMSU5HX1BST1ZJREVSX1NMVUc6IHByb3BzLmJpbGxpbmdQcm92aWRlclNsdWcsXG4gICAgICAgICAgICAgICAgQklMTElOR19QUk9WSURFUl9TRUNSRVRfS0VZOiBwcm9wcy5iaWxsaW5nUHJvdmlkZXJTZWNyZXRLZXksXG4gICAgICAgICAgICAgICAgREVGQVVMVF9QUklDRV9JRDogcHJvcHMuZGVmYXVsdFByaWNlSWRcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuY3JlYXRlVXNlckZ1bmN0aW9uID0gYmlsbGluZ1VzZXJTZXJ2aWNlO1xuICAgICAgICB0aGlzLmRlbGV0ZVVzZXJGdW5jdGlvbiA9IGJpbGxpbmdVc2VyU2VydmljZTtcbiAgICAgICAgdGhpcy5pbmdlc3RvciA9IG51bGwgYXMgYW55OyAvLyBUT0RPLiBXZSBkb24ndCBuZWVkIGFuIGluZ2VzdG9yL2FnZ3JlZ2F0b3JcbiAgICAgICAgdGhpcy5wdXRVc2FnZUZ1bmN0aW9uID0gYmlsbGluZ1VzZXJTZXJ2aWNlOyAgLy8gVE9ETy4gUHJlZmVyIGhhbmRsaW5nIHZpYSBmaXJlaG9zZVxuICAgICAgICB0aGlzLndlYmhvb2tGdW5jdGlvbiA9IG51bGwgYXMgYW55OyAvLyBUT0RPIFdoYXQgaXMgdGhpcyBmb3I/XG4gICAgICAgIHRoaXMud2ViaG9va1BhdGggPSBudWxsIGFzIGFueTsgLy8gVE9ETyBXaGF0IGlzIHRoaXMgZm9yP1xuICAgIH1cbn0iXX0=